name: Web App CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm ci || npm install
        
    - name: Lint HTML
      run: |
        npx html-validate "/*.html" || echo "HTML validation skipped"
        
    - name: Lint CSS
      run: |
        npx stylelint "/*.css" --allow-empty-input || echo "CSS validation skipped"
        
    - name: Lint JavaScript
      run: |
        npx eslint "/*.js" --no-error-on-unmatched-pattern || echo "JavaScript validation skipped"
        
    - name: Extract Jira issue keys from branch name
      id: jira_keys
      if: ${{ github.event_name == 'push' }}
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        JIRA_KEYS=$(echo $BRANCH_NAME | grep -o -E '[A-Z]+-[0-9]+' || echo "")
        echo "keys=$JIRA_KEYS" >> $GITHUB_OUTPUT
        
    - name: Comment on Jira issues
      if: ${{ steps.jira_keys.outputs.keys != '' }}
      uses: atlassian/gajira-comment@v3
      env:
        JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      with:
        issue: ${{ steps.jira_keys.outputs.keys }}
        comment: |
          CI Build Status: ${{ job.status }}
          GitHub Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Commit: ${{ github.event.after }}
          Branch: ${{ github.ref_name }}
